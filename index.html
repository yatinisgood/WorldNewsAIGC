<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World News AI Photo Gallery</title>
    <style>
        /* 隱藏 Google 翻譯工具列 */
        .goog-te-banner-frame.skiptranslate,
        .goog-te-banner-frame {
          display: none !important;
          visibility: hidden !important;
          height: 0 !important;
        }
        /* CSS 樣式維持不變 */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #121212; color: #e0e0e0;top: 0px !important;   /* 避免被 Google 翻譯工具列往下推 */ }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #333; }
        h1 { color: #ffffff; }
        .controls { padding: 20px 0; text-align: center; }
        label { margin-right: 10px; }
        select { font-size: 16px; padding: 8px 12px; border-radius: 5px; border: 1px solid #555; background-color: #2c2c2c; color: #e0e0e0; }
        #image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .thumbnail-container { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .thumbnail { display: block; width: 100%; height: 180px; object-fit: cover; cursor: pointer; transition: transform 0.2s ease-in-out; }
        .thumbnail:hover { transform: scale(1.05); }
        .thumbnail-title { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0, 0, 0, 0.7); color: white; padding: 8px; font-size: 14px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; }
        .lightbox { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); flex-direction: column; justify-content: center; align-items: center; }
        .lightbox-content { position: relative; max-width: 90%; max-height: 80%; display: flex; justify-content: center; align-items: center; }
        .lightbox-image { max-width: 100%; max-height: 100%; object-fit: contain; }
        .lightbox-caption { color: #f0f0f0; margin-top: 25px; text-align: center; padding: 10px 20px; font-size: 18px; height: auto; line-height: 1.5; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); }
        .close, .prev, .next { cursor: pointer; position: absolute; color: white; font-size: 40px; font-weight: bold; transition: 0.3s; user-select: none; z-index: 1001; }
        .close { top: 15px; right: 35px; }
        .prev, .next { top: 50%; transform: translateY(-50%); padding: 16px; }
        .prev { left: 15px; }
        .next { right: 15px; }
        .close:hover, .prev:hover, .next:hover { color: #bbb; }
    </style>
    <!-- 這裡放 cookie 設定 -->
  <script>
  (function setDefaultTranslateCookie() {
    var from = '/en';     // 來源語言
    var to   = '/zh-TW';  // 預設翻譯
    var value = from + to;

    var expires = new Date();
    expires.setFullYear(expires.getFullYear() + 1);
    var exp = ';expires=' + expires.toUTCString();

    document.cookie = 'googtrans=' + value + exp + ';path=/';
    document.cookie = 'googtrans=' + value + exp + ';domain=' + location.hostname + ';path=/';
  })();
  </script>
    

</head>
<body>
    <div id="google_translate_element"></div>
    <div class="container">
        <header><h1>World News AI Photo Gallery</h1></header>
        <div class="controls">
            <label for="date-select">Select Date：</label>
            <select id="date-select"></select>
        </div>
        <main id="image-grid"></main>
    </div>
    <div id="lightbox" class="lightbox">
        <span class="close">&times;</span>
        <div class="lightbox-content">
            <a id="lightbox-link" target="_blank" rel="noopener noreferrer">
                <img class="lightbox-image" id="lightbox-img">
            </a>
        </div>
        <div id="lightbox-caption" class="lightbox-caption"></div>
        <a class="prev">&#10094;</a>
        <a class="next">&#10095;</a>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let galleryData = {}, currentImages = [], currentIndex = 0;
            const dateSelect = document.getElementById('date-select');
            const imageGrid = document.getElementById('image-grid');
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            const lightboxCaption = document.getElementById('lightbox-caption');
            const lightboxLink = document.getElementById('lightbox-link');
            
            
            async function loadGalleryData() {
                try {
                    const response = await fetch(`gallery_data.json?v=${new Date().getTime()}`);
                    if (!response.ok) throw new Error('找不到 gallery_data.json。請先執行 main.py。');
                    const rawData = await response.json();
                    
                    // 步驟 1: 建立一個新的、過濾後的資料物件
                    const filteredData = {};
                    for (const date in rawData) {
                        // 使用 .filter() 方法篩選出 link 有效的項目
                        const validItems = rawData[date].filter(item => item.link && item.link !== '#');
                        
                        // 只有當這個日期下還有有效的項目時，才把它加到新的資料物件中
                        if (validItems.length > 0) {
                            filteredData[date] = validItems;
                        }
                    }
                    
                    // 步驟 2: 使用過濾後的資料來更新全域變數
                    galleryData = filteredData;

                    populateDateSelect();
                    // 檢查過濾後是否還有任何資料
                    const availableDates = Object.keys(galleryData);
                    if (availableDates.length > 0) {
                        loadImagesForDate(availableDates[0]);
                    } else {
                        // 如果所有項目都被過濾掉了，顯示提示訊息
                        imageGrid.innerHTML = `<p style="text-align:center;">沒有找到附帶有效連結的新聞圖片。</p>`;
                    }

                } catch (error) {
                    imageGrid.innerHTML = `<p style="text-align:center;">${error.message}</p>`;
                }
            }

            // 後續的函式現在會自動使用已經被過濾過的 `galleryData`，所以它們無需修改
            function populateDateSelect() {
                const dates = Object.keys(galleryData);
                dateSelect.innerHTML = '';
                // 如果過濾後沒有任何日期，下拉選單會是空的
                dates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date; option.textContent = date;
                    dateSelect.appendChild(option);
                });
            }

            function loadImagesForDate(date) {
                // `galleryData[date]` 已經是過濾後的結果
                currentImages = galleryData[date] || [];
                imageGrid.innerHTML = '';
                currentImages.forEach((image, index) => {
                    const container = document.createElement('div');
                    container.className = 'thumbnail-container';
                    const imgElement = document.createElement('img');
                    imgElement.src = image.file; imgElement.alt = image.title; imgElement.className = 'thumbnail';
                    const titleElement = document.createElement('div');
                    titleElement.className = 'thumbnail-title'; titleElement.textContent = image.title;
                    container.appendChild(imgElement); container.appendChild(titleElement);
                    container.addEventListener('click', () => openLightbox(index));
                    imageGrid.appendChild(container);
                });
            }

            function openLightbox(index) { currentIndex = index; lightbox.style.display = 'flex'; showImage(); }
            function closeLightbox() { lightbox.style.display = 'none'; }
            function changeSlide(n) { currentIndex = (currentIndex + n + currentImages.length) % currentImages.length; showImage(); }

            // showImage 函式現在處理的都是有效連結，但保留邏輯以增加穩健性
            function showImage() {
                if (currentImages.length === 0) return;
                const image = currentImages[currentIndex];
                lightboxImg.src = image.file;
                lightboxCaption.textContent = image.title;
                if (image.link && image.link !== '#') {
                    lightboxLink.href = image.link;
                    lightboxImg.style.cursor = 'pointer';
                    lightboxLink.style.pointerEvents = 'auto';
                } else {
                    lightboxLink.removeAttribute('href');
                    lightboxImg.style.cursor = 'default';
                    lightboxLink.style.pointerEvents = 'none';
                }
            }

            // 事件監聽 (維持不變)
            dateSelect.addEventListener('change', (e) => loadImagesForDate(e.target.value));
            lightbox.querySelector('.close').addEventListener('click', closeLightbox);
            lightbox.querySelector('.prev').addEventListener('click', () => changeSlide(-1));
            lightbox.querySelector('.next').addEventListener('click', () => changeSlide(1));
            document.addEventListener('keydown', e => {
                if (lightbox.style.display === 'flex') {
                    if (e.key === 'ArrowLeft') changeSlide(-1);
                    else if (e.key === 'ArrowRight') changeSlide(1);
                    else if (e.key === 'Escape') closeLightbox();
                }
            });

            loadGalleryData();
        });
    </script>
</body>
<script>
    function googleTranslateElementInit() {
      new google.translate.TranslateElement(
        {
          pageLanguage: 'en',
          includedLanguages: 'en,zh-TW,ja,fr,de,ms,hi',
          layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
          autoDisplay: false
        },
        'google_translate_element'
      );
    }
  </script>
  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

</html>